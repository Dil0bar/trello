{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Task Board</title>
    <link rel="stylesheet" href="{% static 'task_list.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body>

    <h2>üìå My Task Board</h2>
    {% if user.is_authenticated %}
    <h2>Welcome, {{ user.username }}! <a href="{% url 'logout' %}">Logout</a></h2>
    {% else %}
    <h2><a href="{% url 'login' %}">Login</a> | <a href="{% url 'register' %}">Register</a></h2>
    {% endif %}

    <!-- —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <form method="post">
        {% csrf_token %}
        <input type="text" name="title" placeholder="Task title" required>
        <textarea name="description" placeholder="Task description" rows="3" required></textarea>
        <button type="submit">Add Task</button>
    </form>

    <!-- –∫–æ–ª–æ–Ω–∫–∏ -->
    <div class="board">
        <!-- To Do -->
        <div class="column" id="todo">
            <h3>üìù To Do</h3>
            <div class="task-list">
                {% for task in tasks %}
                {% if task.status == "todo" %}
                <div class="task" id="task-{{ task.id }}" data-id="{{ task.id }}" draggable="true"
                    onclick="window.location.href='{% url 'task_detail' task.id %}'">
                    <div class="title">{{ task.position }} . {{ task.title }}</div>
                    <div class="description">{{ task.desc }}</div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- In Progress -->
        <div class="column" id="progress">
            <h3>‚ö° In Progress</h3>
            <div class="task-list">
                {% for task in tasks %}
                {% if task.status == "progress" %}
                <div class="task" id="task-{{ task.id }}" data-id="{{ task.id }}" draggable="true"
                    onclick="window.location.href='{% url 'task_detail' task.id %}'">
                    <div class="title">{{ task.position }} . {{ task.title }}</div>
                    <div class="description">{{ task.desc }}</div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>

        <!-- Done -->
        <div class="column" id="done">
            <h3>‚úÖ Done</h3>
            <div class="task-list">
                {% for task in tasks %}
                {% if task.status == "done" %}
                <div class="task" id="task-{{ task.id }}" data-id="{{ task.id }}" draggable="true"
                    onclick="window.location.href='{% url 'task_detail' task.id %}'">
                    <div class="title">{{ task.position }} . {{ task.title }}</div>
                    <div class="description">{{ task.desc }}</div>
                </div>
                {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤ –≤ –∫–æ–ª–æ–Ω–∫–µ
        function updatePositions(column) {
            column.querySelectorAll(".task").forEach((el, index) => {
                const titleEl = el.querySelector(".title");
                if (titleEl) {
                    const taskTitle = titleEl.textContent.split(".").slice(1).join(".").trim();
                    titleEl.textContent = (index + 1) + " . " + taskTitle;
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SortableJS –¥–ª—è –∫–æ–ª–æ–Ω–æ–∫
        function initSortable(columnId) {
            const list = document.querySelector(`#${columnId} .task-list`);

            return new Sortable(list, {
                group: 'shared',
                animation: 150,
                onEnd: function (evt) {
                    const taskId = evt.item.dataset.id;                 // ID —Ç–∞—Å–∫–∞
                    const newStatus = evt.to.closest(".column").id;     // –∫–æ–ª–æ–Ω–∫–∞
                    const order = [];

                    evt.to.querySelectorAll(".task").forEach((el, index) => {
                        order.push({ id: el.dataset.id, position: index + 1 });
                    });

                    console.log("Task moved:", { taskId, newStatus, order });

                    fetch("/update-task-status/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            new_status: newStatus,
                            order: order
                        })
                    })
                        .then(res => res.json())
                        .then(data => {
                            console.log("Response:", data);

                            // –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ –≤ –∫–æ–ª–æ–Ω–∫–µ, –∫—É–¥–∞ –ø–µ—Ä–µ—Ç–∞—â–∏–ª–∏
                            updatePositions(evt.to);
                        })
                        .catch(err => console.error("Error:", err));
                }
            });
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –¥–ª—è –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
        ["todo", "progress", "done"].forEach(initSortable);
    </script>
</body>

</html>