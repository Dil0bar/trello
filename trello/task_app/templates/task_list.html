<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Board</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f5f6fa;
            margin: 0;
            padding: 20px;
        }
        h2 { text-align: center; }

        .board {
            display: flex;
            justify-content: space-around;
            gap: 20px;
            margin-top: 20px;
        }

        .column {
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            width: 30%;
            min-height: 300px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .column h3 {
            text-align: center;
            margin-bottom: 10px;
        }

        .task {
            background: #f1f2f6;
            margin: 8px 0;
            padding: 10px;
            border-radius: 6px;
            cursor: grab;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .task:hover {
            background: #dcdde1;
        }

        form {
            display: flex;
            flex-direction: column;
            margin: 20px auto;
            max-width: 400px;
            gap: 10px;
        }

        form input, form textarea, form button {
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
            font-size: 14px;
        }

        form button {
            background: #4cd137;
            color: white;
            font-weight: bold;
            border: none;
            cursor: pointer;
        }

        form button:hover {
            background: #44bd32;
        }
    </style>
</head>
<body>
    <h2>üìå My Task Board</h2>

    <!-- —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <form method="post">
        {% csrf_token %}
        <input type="text" name="title" placeholder="Task title" required>
        <textarea name="description" placeholder="Task description" rows="3" required></textarea>
        <button type="submit">Add Task</button>
    </form>

    <!-- –∫–æ–ª–æ–Ω–∫–∏ -->
    <div class="board">
        <div class="column" id="todo" id="todo" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h3>üìù To Do</h3>
            {% for task in tasks %}
                {% if task.status == "todo" %}
                    <div class="task" id="task-{{ task.id }}" draggable="true" ondragstart="drag(event)"
                         onclick="window.location.href='{% url 'task_detail' task.id %}'">
                        <div class="title">{{ forloop.counter }} . {{ task.title }}</div>
                        <div class="description">{{ task.desc }}</div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="column" id="progress" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h3>‚ö° In Progress</h3>
            {% for task in tasks %}
                {% if task.status == "progress" %}
                    <div class="task" id="task-{{ task.id }}" draggable="true" ondragstart="drag(event)"
                         onclick="window.location.href='{% url 'task_detail' task.id %}'">
                        <div class="title">{{ forloop.counter }} . {{ task.title }}</div>
                        <div class="description">{{ task.desc }}</div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>

        <div class="column" id="done" ondrop="drop(event)" ondragover="allowDrop(event)">
            <h3>‚úÖ Done</h3>
            {% for task in tasks %}
                {% if task.status == "done" %}
                    <div class="task" id="task-{{ task.id }}" draggable="true" ondragstart="drag(event)"
                         onclick="window.location.href='{% url 'task_detail' task.id %}'">
                        <div class="title">{{ forloop.counter }} . {{ task.title }}</div>
                        <div class="description">{{ task.desc }}</div>
                    </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ SortableJS
        function initSortable(columnId) {
            return new Sortable(document.getElementById(columnId), {
                group: 'shared',
                animation: 150,
                onEnd: function (evt) {
                    const taskId = evt.item.dataset.id;
                    const newStatus = evt.to.id;

                    // —Å–æ–±–∏—Ä–∞–µ–º –ø–æ—Ä—è–¥–æ–∫
                    const order = [];
                    evt.to.querySelectorAll(".task").forEach((el, index) => {
                        order.push({id: el.dataset.id, position: index});
                    });

                    // –∑–∞–ø—Ä–æ—Å –∫ —Å–µ—Ä–≤–µ—Ä—É
                    fetch("/update-task-status/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}"
                        },
                        body: JSON.stringify({
                            task_id: taskId,
                            new_status: newStatus,
                            order: order
                        })
                    }).then(res => res.json())
                      .then(data => console.log(data))
                      .catch(err => console.error(err));
                }
            });
        }

        // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –¥–ª—è –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫
        ["todo", "progress", "done"].forEach(initSortable);
    </script>
</body>
</html>
